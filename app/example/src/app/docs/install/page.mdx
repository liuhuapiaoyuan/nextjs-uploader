import { SimpleUpload } from './SimpleUpload'

# ğŸ‰ Nextjs-Uploader

ä¸€ä¸ªåŸºäº **Next.js 15** å’Œ **React 19** çš„S3ä¸Šä¼ æ’ä»¶ï¼Œæ—¨åœ¨é€šè¿‡ `serverAction` ç®€åŒ–ä¸Šä¼ æµç¨‹ã€‚

## ğŸš€ ç‰¹æ€§

- **å•æ–‡ä»¶ä¸Šä¼ ** ğŸ—‚ï¸ï¼šæ”¯æŒç®€å•çš„å•æ–‡ä»¶ä¸Šä¼ ã€‚
- **å¤šæ–‡ä»¶ä¸Šä¼ ** ğŸ“ï¼šè½»æ¾é€‰æ‹©å’Œä¸Šä¼ å¤šä¸ªæ–‡ä»¶ã€‚
- **S3 é€‚é…èƒ½åŠ›** â˜ï¸ï¼šæä¾›ä¸ AWS S3 çš„æ— ç¼é›†æˆï¼Œä¾¿äºæ–‡ä»¶å­˜å‚¨ã€‚
- **äº‘å­˜å‚¨é€‚é…**ï¼šåä¸ºäº‘ã€è…¾è®¯äº‘ã€é˜¿é‡Œäº‘ã€ä¸ƒç‰›äº‘ã€åˆæ‹äº‘ç­‰ã€‚
- **TypeScript æ”¯æŒ** â˜•ï¸ï¼šæä¾›å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰æ–‡ä»¶ã€‚

## ğŸ“¦ å®‰è£…

```
npm install @nextjs-uploader/s3
```

æˆ–è€…

```
yarn add @nextjs-uploader/s3
```

### ä½¿ç”¨

#### 1. åˆ›å»º`action.js`æ–‡ä»¶ï¼Œå¹¶å¯¼å‡º`getSignedUrl`æ–¹æ³•

> æ’ä»¶é»˜è®¤é‡‡ç”¨åŸºäºç¯å¢ƒå˜é‡çš„åŠ è½½æœºåˆ¶ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰é…ç½®ï¼Œå®ç°åŸºäºæ•°æ®åº“æˆ–è€…å…¶ä»–é…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥å®ä¾‹åŒ–å­˜å‚¨æ’ä»¶

```typescript
'use server'

import { S3UploaderProvider } from '@nextjs-uploader/s3'
/**
 * å®šä¹‰ç­¾åè·å–ServerAction
 */
export async function getSignedUrl(fileName: string) {
  const provider = createS3Uploader()
  return provider.getSignedUrl(provider.createKey(fileName))
}
```

#### 3. åˆ›å»ºç¯å¢ƒå˜é‡`.env`æ–‡ä»¶

```
# AWS S3å­˜å‚¨æ¡¶çš„åç§°
S3_BUCKET_NAME=
# ç”¨äºè®¿é—®AWS S3çš„è®¿é—®å¯†é’¥ID
S3_ACCESS_KEY_ID=
# è®¿é—®AWS S3çš„ç§˜å¯†è®¿é—®å¯†é’¥
S3_SECRET_ACCESS_KEY=
# S3æœåŠ¡çš„ç«¯ç‚¹URL
S3_ENDPOINT=
# S3å­˜å‚¨æ¡¶æ‰€åœ¨çš„åŒºåŸŸ
S3_REGION=
# ä¸S3é…åˆä½¿ç”¨çš„CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰
S3_CDN=
# å­˜å‚¨æœåŠ¡æä¾›å•†çš„åç§°æˆ–ç±»å‹ (awz,kodo(ä¸ƒç‰›äº‘)ï¼Œoss(é˜¿é‡Œäº‘),cos(è…¾è®¯äº‘))
S3_PROVIDER=awz
```

#### 4. å‰ç«¯å°è£…ä¸Šä¼ å‡½æ•°

```typescript
import { getSignedUrl } from './action'

const handleUpload = async (file: File) => {
  const { url, formData, link } = await getSignedUrl(file.name)
  // è¡¥å……file
  formData.append('file', file)
  const response = await fetch(url, {
    method: 'POST',
    body: formData,
  })
  if (response.ok) {
    console.log('upload success', link)
    return link
  } else {
    console.error('upload failed', response.statusText)
    throw new Error(response.statusText)
  }
}
```

#### 5. åœ¨å®šä¹‰ä¸€ä¸ªç®€å•çš„ç»„ä»¶æ¥ä¸Šä¼ 

```typescript
'use client'

export function SimpleUpload() {
  // å®šä¹‰çŠ¶æ€ï¼š0ï¼šæœªä¸Šä¼ ï¼Œ1ï¼šä¸Šä¼ ä¸­ï¼Œ2ï¼šä¸Šä¼ æˆåŠŸï¼Œ3ï¼šä¸Šä¼ å¤±è´¥
  const [state, setState] = useState(0)
  const [link, setLink] = useState('')

  const handleUpload = async (file: File) => {
    setState(1)
    try {
      const link = await uploadFile(file)
      setState(2)
      setLink(link)
    } catch (error) {
      setState(3)
      console.error(error)
    }
  }
  return (
    <div>
      <Input type='file' onChange={(e) => e.target?.files?.[0] && handleUpload(e.target.files[0]) } />
      <div>
        {state === 0 && 'æœªä¸Šä¼ '}
        {state === 1 && 'ä¸Šä¼ ä¸­...'}
        {state === 2 && (
          <div>
           ä¸Šä¼ æˆåŠŸï¼š
            <a target='_blank' href={link}> {link} </a>
          </div>
        )}
        {state === 3 && 'ä¸Šä¼ å¤±è´¥'}
      </div>
    </div>
  )
}

```

### æ•ˆæœ

<SimpleUpload />
